
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.10">
    
    
      
        <title>Basics - Data Engineering Team 1</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.df45aa19.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.9647289d.min.css">
        
          
          
          <meta name="theme-color" content="#009485">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Krub:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Krub";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="teal" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#basics" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Data Engineering Team 1" class="md-header__button md-logo" aria-label="Data Engineering Team 1" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Data Engineering Team 1
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Basics
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Data Engineering Team 1" class="md-nav__button md-logo" aria-label="Data Engineering Team 1" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Data Engineering Team 1
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Apache Airflow
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Apache Airflow" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Apache Airflow
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Basics
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Basics
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#airflow-architecture" class="md-nav__link">
    Airflow Architecture
  </a>
  
    <nav class="md-nav" aria-label="Airflow Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    จุดสำคัญ
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    กระบวนงานพื้นฐาน
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-1-simple-dag" class="md-nav__link">
    Example 1 - Simple DAG
  </a>
  
    <nav class="md-nav" aria-label="Example 1 - Simple DAG">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-dags" class="md-nav__link">
    Create DAGs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../databases/" class="md-nav__link">
        Databases
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Docker 1
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Docker 1" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Docker 1
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker1/use/" class="md-nav__link">
        Basics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker1/volumes/" class="md-nav__link">
        Volumes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker1/networks/" class="md-nav__link">
        Networks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker1/images/" class="md-nav__link">
        Images
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Docker 2
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Docker 2" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Docker 2
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker2/meacloud/" class="md-nav__link">
        MEA Cloud
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker2/networks/" class="md-nav__link">
        Networks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker2/compose/" class="md-nav__link">
        Compose
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker2/swarm/" class="md-nav__link">
        Docker Swarm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../docker2/secrets/" class="md-nav__link">
        Docker Secrets
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Databases
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Databases" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Databases
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../databases/postgres/" class="md-nav__link">
        PostgreSQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../databases/mongo/" class="md-nav__link">
        MongoDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../databases/redis/" class="md-nav__link">
        Redis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../databases/neo4j/" class="md-nav__link">
        Neo4J
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#airflow-architecture" class="md-nav__link">
    Airflow Architecture
  </a>
  
    <nav class="md-nav" aria-label="Airflow Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    จุดสำคัญ
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    กระบวนงานพื้นฐาน
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-1-simple-dag" class="md-nav__link">
    Example 1 - Simple DAG
  </a>
  
    <nav class="md-nav" aria-label="Example 1 - Simple DAG">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-dags" class="md-nav__link">
    Create DAGs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="basics">Basics</h1>
<h2 id="prerequisites">Prerequisites</h2>
<p>ทักษะพื้นฐานที่ควรมี</p>
<ul>
<li>Python 3.6+</li>
<li>Basic Apache Airflow</li>
<li>Basic databases</li>
<li>Linux</li>
</ul>
<h2 id="airflow-architecture">Airflow Architecture</h2>
<p><img alt="Airflow Architecture" src="../images/airflow_architecture.png" /></p>
<h3 id="_1">จุดสำคัญ</h3>
<ul>
<li>Airflow อ่าน DAGs จาก Bucket ชื่อ <code>dags</code> ใน MinIO มีการซิงค์ข้อมูลทุกๆ 1 นาที</li>
<li>Airflow เชื่อมต่อกับ Data Platform Services หลังบ้าน เช่น Hive, Impala, HBase, Spark</li>
<li>Airflow เชื่อมต่อกับฐานข้อมูลใน MEA บางส่วน เช่น SAP SFTP, AMR Oracle Database, OT MSSQL Database, etc.</li>
<li>Airflow ใช้งาน Docker และติดตั้งแบบ Celery Executor มี 15 Workers</li>
<li>Airflow Server มี 92 vCPUs และ 312 GB RAM</li>
</ul>
<h3 id="_2">กระบวนงานพื้นฐาน</h3>
<ol>
<li>เขียน DAGs ด้วยภาษา Python</li>
<li>Log in เข้าใช้งาน <a href="http://172.17.113.251:9000">MinIO Server</a> และให้อัพโหลดไฟล์ <code>.py</code> เข้าไปที่ Bucket ชื่อ <code>dags</code>.</li>
<li>ถ้าไม่มีข้อผิดพลาด Airflow จะทำการซิงค์ DAGs ภายใน 2 - 3 นาที ถ้ามีความผิดพลาดหน้าต่าง UI จะแจ้ง</li>
<li>เข้าไปตรวจสอบและบริหารจัดการ DAGs ได้ที่ <a href="http://airflow.mea.or.th:8080">Airflow Web UI</a>.</li>
</ol>
<h2 id="example-1-simple-dag">Example 1 - Simple DAG</h2>
<h3 id="create-dags">Create DAGs</h3>
<p>Copy code ด้านล่างและเซฟเป็นชื่อ <code>dpd_training_&lt;name&gt;.py</code></p>
<p>```py title="dpd_training_chatree.py" linenums="1"
import airflow
from airflow import DAG
from airflow.operators.dummy import DummyOperator</p>
<h1 id="initialize-the-dag">Initialize the DAG</h1>
<p>with DAG(
    dag_id="dpd_training_chatree",
    description="DAG for learning Apache Airflow",
    start_date=airflow.utils.dates.days_ago(1),
    schedule_interval="@daily"
) as dag:</p>
<pre><code>task1 = DummyOperator(task_id="task1")
task2 = DummyOperator(task_id="task2")
task3 = DummyOperator(task_id="task3")
task4 = DummyOperator(task_id="task4")

task1 &gt;&gt; task2 &gt;&gt; task3 &gt;&gt; task4
</code></pre>
<p>```</p>
<p>จุดสำคัญ</p>
<ul>
<li><strong>Line 8</strong>: DAG ID ต้อง<strong>ไม่ซ้ำกัน</strong> (Globally unique)</li>
<li><strong>Line 10</strong>: <code>start_date</code> คือวันที่ต้องการให้ DAG เริ่มทำงาน ใช้ <code>datetime</code> หรือ <code>airflow.utils.dates</code> ก็ได้</li>
<li><strong>Line 11</strong>: <code>schedule_interval</code> คือรอบการรัน DAG เช่น <code>@daily</code> คือ ให้รันรายวัน, <code>@monthly</code> คือรันรายเดือน</li>
</ul>
<h3 id="objective">Objective</h3>
<p>ต้องการสร้าง DAG ที่รันได้ แต่ไม่มีฟังก์ชั่นใดๆ</p>
<h3 id="deploy-dags">Deploy DAGs</h3>
<p>เปิดเว็บไซต์ของ MinIO ที่ <a href="http://172.17.113.251:9000">http://172.17.113.251:9000</a> และเลือกที่ Bucket <code>dags</code> จากนั้นลากไฟล์ <code>dpd_training_&lt;name&gt;.py</code> บนเครื่องไปใส่ใน <code>dags</code></p>
<p><img alt="Deploy DAG" src="../images/deploy_dag.png" /></p>
<h3 id="manage-dags">Manage DAGs</h3>
<p>เปิดเว็บไซต์ Airflow UI ที่ <a href="http://airflow.mea.or.th">http://airflow.mea.or.th</a> รอประมาณ 2 - 3 นาที แล้วลองค้นหา DAG ด้วยชื่อ <code>dpd_training</code> จะเห็น DAG ที่อัพโหลดเข้าไป บริหารจัดการ เปิดปิด DAG ได้เลย</p>
<p><img alt="Manage DAG" src="../images/manage_dag.png" /></p>
<h3 id="results">Results</h3>
<p>กด Switch ข้างซ้ายเพื่อเปิดการทำงานของ DAG และ ดูผลลัพธ์</p>
<p><img alt="Result 0" src="../images/result_0.png" /></p>
<p><img alt="Result 1" src="../images/result_1.png" /></p>
<h2 id="example-2-read-from-minio">Example 2 - Read from MinIO</h2>
<p>ถ้าต้องการนำไฟล์พวก CSV, JSON หรือ อื่นๆ เข้าไปประมวลผลใน Airflow ขั้นตอนคือ</p>
<ol>
<li>อัพโหลดไฟล์ใน Bucket ชื่อ <code>airflow</code> (เฉพาะ Data Engineer) หรือ <code>public</code> (เห็นได้ทุกคน)</li>
<li>เขียน DAG ให้ดาวโหลดไฟล์จาก MinIO</li>
<li>Deploy DAG บน MinIO Bucket <code>dags</code></li>
<li>บริหารจัดการ DAG บน Airflow UI</li>
</ol>
<h3 id="objective_1">Objective</h3>
<p>ต้องการสร้าง DAG ที่ดาวโหลดข้อมูลจาก MinIO และส่งไฟล์ที่ดาวโหลดเข้าอีเมลล์พนักงาน กฟน.</p>
<h3 id="upload-files">Upload files</h3>
<p>เอาไฟล์ที่ต้องการโยนเข้าไปใน <code>airflow</code> Bucket</p>
<p><img alt="Airflow Upload" src="../images/airflow_upload.png" /></p>
<h3 id="create-dag">Create DAG</h3>
<p>Copy code ด้านล่างใส่ไฟล์ชื่อ <code>dpd_training_minio_&lt;name&gt;.py</code> ถ้าต้องการศึกษาเพิ่มเติมดูที่</p>
<ul>
<li><a href="https://dataplatform-portal.vercel.app/docs/use/minio#%E0%B8%94%E0%B8%B2%E0%B8%A7%E0%B9%82%E0%B8%AB%E0%B8%A5%E0%B8%94%E0%B9%84%E0%B8%9F%E0%B8%A5%E0%B9%8C">ตัวอย่างโดยละเอียดอ่านที่ ตัวอย่างการอ่านไฟล์ CSV จาก MinIO</a></li>
<li><a href="https://docs.min.io/docs/python-client-api-reference.html">MinIO Python SDK</a></li>
</ul>
<p>```py title="dpd_training_minio_chatree.py" linenums="1"
import airflow
import urllib3
from minio import Minio
from airflow import DAG
from airflow.models import Variable
from airflow.operators.email import EmailOperator
from airflow.operators.python import PythonOperator</p>
<h1 id="initialize-the-dag_1">Initialize the DAG</h1>
<p>with DAG(
    dag_id="dpd_training_minio_chatree",
    description="Download file from MinIO to Airflow Cluster",
    start_date=airflow.utils.dates.days_ago(1),
    schedule_interval="@daily"
) as dag:</p>
<pre><code># define python function to be used with PythonOperator
def _read_file_from_minio(obj, bucket, out):
    client = Minio(
        Variable.get('MINIO_HOST'),
        access_key=Variable.get('MINIO_SECRET_ACCESS_KEY'),
        secret_key=Variable.get('MINIO_SECRET_KEY'),
        secure=False,
        http_client=urllib3.ProxyManager('http://meaproxy.mea.or.th:80')
    )

    client.fget_object(
        bucket_name=bucket,
        object_name=obj,
        file_path=out
    )


download_file = PythonOperator(
    task_id="download_file",
    python_callable=_read_file_from_minio,
    op_kwargs={
        "obj": 'DPD/crash_catalonia.csv',
        "bucket": 'airflow',
        "out": '/shared/crash_catalonia.csv'
    }
)

send_file = EmailOperator(
    task_id="send_file",
    to=["chatree.sr@mea.or.th"],
    subject="[{{ ds }}] File downloaded from MinIO",
    html_content="""
    &lt;p&gt;Please find attached&lt;/p&gt;
    """,
    files=["/shared/crash_catalonia.csv"]
)

download_file &gt;&gt; send_file
</code></pre>
<p>```</p>
<p>จุดสำคัญ</p>
<ul>
<li><strong>Line 5</strong>: ประกาศตัวแปรที่ไม่ต้องการเปิดเผยค่า เช่น Password, Key ผ่านหน้าต่าง Airflow UI &gt; Admin &gt; Variables</li>
<li><strong>Line 6-7</strong>: Operator คือ Code ที่มีคนเขียนมาให้ ใช้แก้ปัญหาเฉพาะจุด เช่น <code>EmailOperator</code> ใช้ส่ง Email, <code>PythonOperator</code> ใช้รันโปรแกรม Python</li>
<li><strong>Line 19-25</strong>: เขียน Function ใช้อ้างถึงตอนใช้งาน <code>PythonOperator</code> ตัว MinIO จะต้องใช้ <code>http_client=urllib3.ProxyManager</code> ด้วยเนื่องจาก Network กฟน. ต้องผ่าน Proxy</li>
<li><strong>Line 38</strong>: Pass arguments ไปที่ <code>python_callable</code> ด้วย <code>op_kwargs={}</code></li>
<li><strong>Line 41</strong>: Airflow มี Workers 15 ตัว แต่ละตัวมี File System ของตัวเอง สาเหตุที่ต้องใช้ Path <code>/shared</code> เพราะว่าเป็น Shared Path เดียวที่ Worker ทุกตัวเข้าถึงได้</li>
<li><strong>Line 45</strong>: ส่งเมลล์พร้อมแนบไฟล์ได้เลย ไม่ต้อง Config SMTP (เพราะตั้งค่าหลังบ้านไว้หมดแล้ว)</li>
<li><strong>Line 47</strong>: เปลี่ยนเป็น Email ของตัวเอง เพื่อตรวจสอบผลลัพธ์</li>
<li><strong>Line 48</strong>: <code>{{ ds }}</code> คือ Jinja Template ที่ Airflow ใช้แทนค่าตัวแปรต่างๆ เช่น <code>ds</code> คือ Dag Run Date ตัวอย่างอื่นๆดูที่ <a href="https://airflow.apache.org/docs/apache-airflow/stable/templates-ref.html">Template Reference</a></li>
</ul>
<h3 id="deploy-dag">Deploy DAG</h3>
<p>เปิดเว็บไซต์ของ MinIO ที่ <a href="http://172.17.113.251:9000">http://172.17.113.251:9000</a> และเลือกที่ Bucket <code>dags</code> จากนั้นลากไฟล์ <code>dpd_training_minio_&lt;name&gt;.py</code> บนเครื่องไปใส่ใน <code>dags</code></p>
<h3 id="manage-dag">Manage DAG</h3>
<p>เปิดเว็บไซต์ Airflow UI ที่ <a href="http://airflow.mea.or.th">http://airflow.mea.or.th</a> รอประมาณ 2 - 3 นาที แล้วลองค้นหา DAG ด้วยชื่อ <code>dpd_training</code> จะเห็น DAG ที่อัพโหลดเข้าไป บริหารจัดการ เปิดปิด DAG ได้เลย</p>
<h3 id="results_1">Results</h3>
<ul>
<li>เช็คหน้าต่าง UI จะเห็นว่า Task รันเสร็จหมดแล้ว</li>
<li>เช็คอีเมลล์ของตัวเอง ดูไฟล์ที่ส่งออกมาจาก Airflow</li>
</ul>
<p><img alt="Email Result" src="../images/email_result.png" /></p>
<h2 id="example-3-pandas-rest-api">Example 3 - Pandas &amp; REST API</h2>
<p>ตังแต่ตัวอย่างนี้เป็นต้นไปจะไม่แสดงวิธีการ Deploy และ Manage DAG</p>
<h3 id="objective_2">Objective</h3>
<p>ต้องการสร้าง DAG ที่</p>
<ol>
<li>ดึงข้อมูลจาก EGAT API</li>
<li>ประมวลผลด้วย Pandas</li>
<li>บันทึกไฟล์เพื่อ Backup บน MinIO</li>
<li>จัดเก็บข้อมูลใน Hive</li>
<li>ส่งเมลล์พร้อมไฟล์แนบให้หน่วยงานที่เกี่ยวข้อง</li>
</ol>
<h3 id="create-dag_1">Create DAG</h3>
<p>```py title="dpd_training_egat_chatree.py" linenums="1"
import airflow
import json
import urllib3
import requests
import numpy as np
import pandas as pd
from minio import Minio
from airflow import DAG
from airflow.models import Variable
from airflow.operators.email import EmailOperator
from airflow.operators.python import PythonOperator
from airflow.providers.jdbc.operators.jdbc import JdbcOperator</p>
<h1 id="custom-mea-hooks">Custom MEA hooks</h1>
<p>from mea.hooks.webhdfs import WebHDFSHook</p>
<h1 id="initialize-the-dag_2">Initialize the DAG</h1>
<p>with DAG(
    dag_id="dpd_training_minio_egat_chatree",
    description="Store data from EGAT API to Data Platform ",
    start_date=airflow.utils.dates.days_ago(1),
    template_searchpath=["/shared"],
    schedule_interval="@daily"
) as dag:</p>
<pre><code>###############################################################################
#               Utility functions; Should be in a separate file.              #
###############################################################################
def _get_token():
    headers = {
        'Content-Type': 'application/json'
    }

    data = {
        "username": Variable.get('DPD_EGAT_API_ACCESS_KEY'),
        "password": Variable.get('DPD_EGAT_API_SECRET_KEY')
    }

    try:
        res = requests.post(
            Variable.get('DPD_EGAT_API_AUTH_URL'),
            headers=headers,
            json=data
        )
        res.raise_for_status()
    except requests.exceptions.HTTPError as e:
        raise SystemExit(e)

    return res.json().get('access_token')

def _get_data(api_url, feeder_name, year, month, outfile):
    token = _get_token()

    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {token}"
    }

    data = {
        "linefeederName": feeder_name,
        "year": year,
        "month": month
    }

    try:
        res = requests.post(
            Variable.get(api_url),
            headers=headers,
            json=data
        )
    except requests.exceptions.HTTPError as e:
        raise SystemExit(e)

    with open(outfile, 'w') as f:
        json.dump(res.json(), f)

def _get_billing(feeder_name, year, month, outfile):
    _get_data('DPD_EGAT_API_BILLING_URL', feeder_name, year, month, outfile)

def _get_lp(feeder_name, year, month, outfile):
    _get_data('DPD_EGAT_API_LP_URL', feeder_name, year, month, outfile)

def _convert_json_to_csv(infile, outfile):
    with open(infile, 'r') as f:
        records = json.load(f)

    # Convert JSON to DataFrame and save to CSV
    pd.DataFrame.from_records(records).to_csv(outfile, index=False)

def _generate_hive_sql(infile, outfile, db_name, table_name, hdfs_path):
    df = pd.read_csv(infile)

    with open(outfile, 'w') as f:
        f.write(f'CREATE EXTERNAL TABLE IF NOT EXISTS {db_name}.{table_name}(\n')
        for col in df.columns:
            if df[col].dtype == object:
                f.write(f'\t{col} STRING')

            if df[col].dtype == np.int64:
                f.write(f'\t{col} DOUBLE')

            if df[col].dtype == np.float64:
                f.write(f'\t{col} DOUBLE')

            if col != df.columns[-1]:
                f.write(',\n')

        f.write(')\n')
        f.write('ROW FORMAT DELIMITED\n')
        f.write("FIELDS TERMINATED BY ','\n")
        f.write('STORED AS TEXTFILE\n')
        f.write(f"LOCATION '{hdfs_path}'\n")
        f.write("TBLPROPERTIES ('skip.header.line.count'='1');")

def _upload_file_to_hdfs(infile, hdfs_path):
    hdfs = WebHDFSHook(webhdfs_conn_id='sys-hdfs')
    hdfs.load_file(
        source=infile,
        destination=hdfs_path,
        overwrite=True
    )

def _upload_file_to_minio(obj, bucket, file_path):
    client = Minio(
        Variable.get('MINIO_HOST'),
        access_key=Variable.get('MINIO_SECRET_ACCESS_KEY'),
        secret_key=Variable.get('MINIO_SECRET_KEY'),
        secure=False,
        http_client=urllib3.ProxyManager('http://meaproxy.mea.or.th:80')
    )

    client.fput_object(
        bucket_name=bucket,
        object_name=obj,
        file_path=file_path
    )


###############################################################################
#                                    Tasks                                    #
###############################################################################
get_egat_lp = PythonOperator(
    task_id="get_egat_lp",
    python_callable=_get_lp,
    op_kwargs={
        "feeder_name": "BK/69 MEA#1 M",
        "year": 2021,
        "month": 12,
        "outfile": "/shared/bk69_mea1_m.json"
    }
)

convert_json_to_csv = PythonOperator(
    task_id="convert_json_to_csv",
    python_callable=_convert_json_to_csv,
    op_kwargs={
        "infile": "/shared/bk69_mea1_m.json",
        "outfile": "/shared/bk69_mea1_m.csv"
    }
)

upload_file_to_hdfs = PythonOperator(
    task_id="upload_file_to_hdfs",
    python_callable=_upload_file_to_hdfs,
    op_kwargs={
        "infile": '/shared/bk69_mea1_m.csv',
        "hdfs_path": '/user/airflow/dpd-training/egat/bk69_mea1_m.csv'
    }
)

upload_backup_to_minio = PythonOperator(
    task_id="upload_backup_to_minio",
    python_callable=_upload_file_to_minio,
    op_kwargs={
        'bucket': 'airflow',
        'obj': 'DPD/bk69_mea1_m.csv',
        'file_path': '/shared/bk69_mea1_m.csv'
    }
)

generate_hive_sql = PythonOperator(
    task_id="generate_hive_sql",
    python_callable=_generate_hive_sql,
    op_kwargs={
        "infile": '/shared/bk69_mea1_m.csv',
        "outfile": '/shared/bk69_mea1_m.sql',
        "db_name": 'airflow',
        "table_name": 'dpd_training_egat_chatree',
        "hdfs_path": '/user/airflow/dpd-training/egat/'
    }
)

create_external_table = JdbcOperator(
    task_id="create_external_table",
    jdbc_conn_id='sys-jdbc-hive',
    sql="bk69_mea1_m.sql"
)

send_email = EmailOperator(
    task_id="send_email",
    to=["chatree.sr@mea.or.th"],
    subject="[{{ ds }}] EGAT file saved!",
    html_content="""
    &lt;h1 style="color: blue;"&gt;Please find attached&lt;/h1&gt;
    &lt;p&gt;Please find attached EGAT data as of {{ ds }}&lt;/p&gt;
    """,
    files=["/shared/bk69_mea1_m.csv"]
)


get_egat_lp &gt;&gt; convert_json_to_csv &gt;&gt; upload_file_to_hdfs &gt;&gt; generate_hive_sql &gt;&gt; create_external_table &gt;&gt; send_email
convert_json_to_csv &gt;&gt; upload_backup_to_minio &gt;&gt; send_email
</code></pre>
<p>```</p>
<p>จุดสำคัญ</p>
<ul>
<li>อะไรที่ทำบน Python ได้ ทำบน Airflow ได้เหมือนกัน</li>
<li>ส่วนใหญ่จะมี Operator เฉพาะกิจไว้ให้แล้ว ตรวจสอบรายการได้ที่ <a href="https://airflow.apache.org/docs/apache-airflow-providers/operators-and-hooks-ref/index.html">Airflow Operators &amp; Hooks</a></li>
<li>ฝวท. พัฒนา Custom Hooks &amp; Operators บางส่วนเพื่อให้สามารถเชื่อมต่อ Data Platform ได้ เช่น <code>mea.hooks.webhdfs</code></li>
</ul>
<h3 id="results_2">Results</h3>
<p><img alt="EGAT Result" src="../images/egat_result_0.png" /></p>
<p><img alt="EGAT Result" src="../images/egat_result_1.png" /></p>
<p><img alt="EGAT Result" src="../images/egat_result_2.png" /></p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../.." class="md-footer__link md-footer__link--prev" aria-label="Previous: Home" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Home
            </div>
          </div>
        </a>
      
      
        
        <a href="../databases/" class="md-footer__link md-footer__link--next" aria-label="Next: Databases" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Databases
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.748e2769.min.js"></script>
      
    
  </body>
</html>